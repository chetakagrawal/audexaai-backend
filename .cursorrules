# Cursor Project Rules — Backend
FastAPI · Python 3.13 · Poetry · Postgres · SQLAlchemy 2.x (async) · Alembic · JWT

---

## 1. Non-negotiables
- TDD required: tests first → minimal code → refactor.
- No tests = not done.
- No backward-compat guarantees in dev; tests define the contract.

---

## 2. Architecture & layering
api/        → routers, request/response schemas, auth dependencies  
services/   → business logic only  
repos/      → DB access only  
models/     → SQLAlchemy models  
schemas/    → Pydantic DTOs  
core/       → config, security, logging  

Rules:
- Routers → Services → Repos → DB
- No DB calls in routers
- No HTTP concepts in services or repos

---

## 3. Design references (source of truth)
- docs/architecture/erd.md
- docs/architecture/erd_explained.md
- docs/architecture/multi_tenant_architecture.md

Rules:
- ERD is a reference, not a schema generator.
- Schema changes must move incrementally toward the ERD.
- Never generate all tables from the ERD in one migration.

---

## 4. Multi-tenant safety
Every request must resolve:
- User
- Membership (UserTenant.id)
- Tenant (derived)

Rules:
- Never accept tenant_id from client input.
- Every tenant-owned table must include tenant_id.
- Tenant-scoped ownership must reference UserTenant.id.
- All tenant-scoped queries must filter by tenant_id.

---

## 5. Database rules
- SQLAlchemy async only.
- Explicit transactions for multi-step writes.
- Sessions via dependency injection.
- Required indexes:
  - (tenant_id, id)
  - (tenant_id, business_key)

---

## 6. Alembic & migrations
- Any model change requires a migration.
- Migrations must be small and reversible.
- Pattern for required columns:
  1. add nullable
  2. backfill
  3. enforce NOT NULL + FK + index

---

## 7. Auth & JWT
- JWT logic lives in core/security.py.
- Never log tokens or secrets.

Required tests:
- valid token
- invalid / expired token rejected
- cross-tenant access blocked

---

## 8. Testing
- pytest + pytest-asyncio + httpx.AsyncClient
- Ephemeral DB preferred.
- No real network calls.
- Deterministic tests only.

Each change must include:
- happy path
- auth failure
- validation failure
- tenant isolation test

---

## 9. Error handling
Centralized exception handlers.
Consistent error shape:
{
  "error": {
    "code": "...",
    "message": "...",
    "details": ...
  }
}

---

## 10. Code quality
- Type hints on public functions.
- Small, readable functions.
- Structured logging only.
- No leftover TODOs.

---

## 11. Required self-check
Include in final response:
1. Files changed
2. How to run tests
3. Migrations added (if any)
4. Tenant isolation verified
5. Auth behavior verified

---

## 12. Task template
Task: Implement <feature> using strict TDD.

Steps:
1) Write failing tests
2) Implement minimal code
3) Add edge + tenant tests
4) Add migration if needed
5) Final summary + self-check
